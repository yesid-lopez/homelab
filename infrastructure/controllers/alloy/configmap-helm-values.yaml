---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-helm-chart-value-overrides
  namespace: alloy
data:
  values.yaml: |
    alloy:
      configMap:
        content: |
          // Loki remote write
          loki.write "default" {
            endpoint {
              url = "http://loki-gateway.loki:80/loki/api/v1/push"
            }
          }
          
          // Kubernetes logs collection - limit to application namespaces
          discovery.kubernetes "pods" {
            role = "pod"
            namespaces {
              names = ["resumelo", "resumelo-dev", "langfuse", "umami", "grafana", "loki", "alloy"]
            }
          }
          
          // Relabel to use pod name as service
          discovery.relabel "kubernetes_pods" {
            targets = discovery.kubernetes.pods.targets
            
            rule {
              source_labels = ["__meta_kubernetes_pod_name"]
              target_label  = "service"
            }
            
            rule {
              source_labels = ["__meta_kubernetes_namespace"]
              target_label  = "namespace"
            }
            
            rule {
              source_labels = ["__meta_kubernetes_pod_container_name"]
              target_label  = "container"
            }
          }
          
          loki.source.kubernetes "pods" {
            targets    = discovery.relabel.kubernetes_pods.output
            forward_to = [loki.process.filter_health_checks.receiver]
          }
          
          // Filter out health check logs
          loki.process "filter_health_checks" {
            forward_to = [loki.write.default.receiver]
            
            stage.drop {
              expression = `.*(/health|/healthz|/ping|/status|GET /|HEAD /).*`
            }
          }
    
    controller:
      type: daemonset
      
    resources:
      limits:
        memory: 512Mi
        cpu: 500m
      requests:
        memory: 128Mi
        cpu: 100m
        
    securityContext:
      fsGroup: 10001
      runAsGroup: 10001
      runAsNonRoot: true
      runAsUser: 10001
      
    # Increase file descriptor limits
    extraEnv:
      - name: GOMEMLIMIT
        value: 400MiB
        
    # Set container limits  
    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 65534
      
    # Pod-level security context
    podSecurityContext:
      fsGroup: 65534
      runAsGroup: 65534
      runAsNonRoot: true
      runAsUser: 65534
      seccompProfile:
        type: RuntimeDefault
      
    serviceAccount:
      create: true